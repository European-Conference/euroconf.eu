{{ $speaker_appears := false}}
{{ if $.for_speaker }}
  {{ if eq .event.moderator $.for_speaker }}
    {{ $speaker_appears = true }}
  {{ end }}
  {{ if eq .event.code $.pan }}
    {{ $speaker_appears = true }}
  {{ end }}
{{ else }}
  {{ $speaker_appears = true }}
{{ end }}

{{ if $speaker_appears }}
  {{$speakerLinks := slice}}
  {{ range $value := .event}}
    {{ $pages := (where $.root.Site.RegularPages "Section" "speakers") }} 
    {{ $speakers := (where $pages Page.Params.panel $value.code) }} 
    {{ $speaker := index $speakers 0}} 
    {{ if $speaker }}
      {{ $speakerLinks = $speakerLinks | append (printf "<a href='%s'>%s</a>" $speaker.RelPermalink $speaker.Params.name) }}
    {{end}}
  {{end}}

<div class="schedule-event {{ .event.type }}">
  <div class="event-info">
    {{ if eq .event.type "keynote"}}
      <span class="event-type-tag">Keynote Address</span><br />
    {{end}}
    {{ if eq .event.type "panel"}}
      <span class="event-type-tag">Panel</span><br />
    {{end}}
    {{ if eq .event.type "workshop"}}
      <span class="event-type-tag">Workshop</span><br />
    {{end}}
    <span class="event-title"> {{.event.content | safeHTML}} </span>
    
    <span class="event-speakers">
      {{ range $key, $value := $speakerLinks}}
        {{if $key}}
          |
        {{end}}
        {{safeHTML $value}}
      {{end}}
    </span>
    
    <span class="event-moderators">
      {{ if in .event.moderator " " }}
        Moderated by {{.event.moderator | safeHTML}}
      {{ else }}
        {{ $pages := (where $.root.Site.RegularPages "Section" "speakers") }}
        {{ $moderators := (where $pages "File.ContentBaseName" .event.moderator) }}
        {{ $moderator := index $moderators 0}}
        {{ if $moderator }}
          {{ $moderatorLink := printf "<a href='%s'>%s</a>" $moderator.RelPermalink $moderator.Params.name}}
          {{ $moderatorText := "Moderated by "}}
          {{ if .event.moderatorText }}
            {{ $moderatorText = .event.moderatorText }}
          {{ end }}
          {{$moderatorText}}
          {{ safeHTML $moderatorLink }}
        {{ end }}
      {{ end }}
    </span>
  </div>

  <div class="event-location"> {{ .event.location }} </div>
</div>
{{end}}
